#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ•°æ®ä¿æŠ¤ç³»ç»Ÿ - é˜²æ­¢è¯¯åˆ é™¤å’Œç ´åæ€§æ•°æ®åŒæ­¥
"""

import pymysql
import json
import hashlib
from datetime import datetime
from pathlib import Path
import sys
import os

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from dotenv import load_dotenv

load_dotenv('/opt/mysql-sync/.env')

import subprocess

def send_alert(message, severity='CRITICAL'):
    """å‘é€é‚®ä»¶å‘Šè­¦"""
    try:
        subprocess.run([
            'python3',
            '/opt/mysql-sync/scripts/alert_email.py',
            message,
            severity
        ], timeout=30, check=False)
        print("  ðŸ“§ é‚®ä»¶å‘Šè­¦å·²å‘é€")
    except Exception as e:
        print(f"  âš ï¸  é‚®ä»¶å‘é€å¤±è´¥: {e}")



class DataProtector:
    def __init__(self):
        self.cache_dir = Path('/opt/mysql-sync/cache')
        self.cache_dir.mkdir(exist_ok=True)
        
        self.baseline_file = self.cache_dir / 'baseline.json'
        self.alert_file = self.cache_dir / 'alerts.json'
        
        self.load_baseline()
        
    def connect_db(self, prefix='MIDDLE'):
        """è¿žæŽ¥æ•°æ®åº“"""
        return pymysql.connect(
            host=os.getenv(f'{prefix}_HOST'),
            port=int(os.getenv(f'{prefix}_PORT', 3306)),
            user=os.getenv(f'{prefix}_USER'),
            password=os.getenv(f'{prefix}_PASS'),
            database=os.getenv(f'{prefix}_DB'),
            charset='utf8mb4',
            cursorclass=pymysql.cursors.DictCursor
        )
    
    def load_baseline(self):
        """åŠ è½½åŸºçº¿æ•°æ®"""
        if self.baseline_file.exists():
            with open(self.baseline_file, 'r') as f:
                self.baseline = json.load(f)
        else:
            self.baseline = {
                'table_schemas': {},
                'row_counts': {},
                'last_update': None
            }
    
    def save_baseline(self):
        """ä¿å­˜åŸºçº¿æ•°æ®"""
        self.baseline['last_update'] = datetime.now().isoformat()
        with open(self.baseline_file, 'w') as f:
            json.dump(self.baseline, f, indent=2)
    
    def create_baseline(self):
        """åˆ›å»ºåŸºçº¿å¿«ç…§"""
        print("ðŸ“¸ åˆ›å»ºæ•°æ®åŸºçº¿å¿«ç…§...")
        
        conn = self.connect_db('MIDDLE')
        cursor = conn.cursor()
        
        cursor.execute("SHOW TABLES")
        tables = [list(row.values())[0] for row in cursor.fetchall()]
        
        for table in tables:
            if table.startswith('_'):
                continue
            
            try:
                # è¡¨ç»“æž„å“ˆå¸Œ
                cursor.execute(f"SHOW CREATE TABLE `{table}`")
                create_stmt = cursor.fetchone()
                schema_hash = hashlib.md5(
                    str(create_stmt).encode()
                ).hexdigest()
                
                self.baseline['table_schemas'][table] = schema_hash
                
                # è¡Œæ•°
                cursor.execute(f"SELECT COUNT(*) as cnt FROM `{table}`")
                row_count = cursor.fetchone()['cnt']
                self.baseline['row_counts'][table] = row_count
                
                print(f"  âœ“ {table}: {row_count:,} rows")
            except Exception as e:
                print(f"  âœ— {table}: {e}")
        
        cursor.close()
        conn.close()
        
        self.save_baseline()
        print(f"\nâœ… åŸºçº¿å·²ä¿å­˜: {len([t for t in tables if not t.startswith('_')])} ä¸ªè¡¨")
    
    def check_delete_anomaly(self):
        """æ£€æµ‹å¤§è§„æ¨¡åˆ é™¤"""
        print("\nðŸ” æ£€æŸ¥æ•°æ®åˆ é™¤å¼‚å¸¸...")
        
        conn = self.connect_db('MIDDLE')
        cursor = conn.cursor()
        
        alerts = []
        delete_threshold = float(os.getenv('DELETE_THRESHOLD_PERCENT', 10))
        
        for table, baseline_count in self.baseline['row_counts'].items():
            try:
                cursor.execute(f"SELECT COUNT(*) as cnt FROM `{table}`")
                current_count = cursor.fetchone()['cnt']
                
                if baseline_count > 0:
                    decrease_percent = ((baseline_count - current_count) / baseline_count) * 100
                    
                    if decrease_percent > delete_threshold:
                        alert = {
                            'type': 'MASSIVE_DELETE',
                            'severity': 'CRITICAL',
                            'table': table,
                            'baseline_rows': baseline_count,
                            'current_rows': current_count,
                            'decrease_percent': round(decrease_percent, 2),
                            'timestamp': datetime.now().isoformat()
                        }
                        alerts.append(alert)
                        print(f"  ðŸš¨ {table}: {baseline_count:,} â†’ {current_count:,} (-{decrease_percent:.1f}%)")
                    else:
                        print(f"  âœ“ {table}: {current_count:,} rows")
                
            except Exception as e:
                print(f"  âš ï¸  {table}: {e}")
        
        cursor.close()
        conn.close()
        
        return alerts
    
    def check_schema_change(self):
        """æ£€æµ‹è¡¨ç»“æž„å˜æ›´"""
        print("\nðŸ” æ£€æŸ¥è¡¨ç»“æž„å˜æ›´...")
        
        conn = self.connect_db('MIDDLE')
        cursor = conn.cursor()
        
        alerts = []
        
        cursor.execute("SHOW TABLES")
        current_tables = [list(row.values())[0] for row in cursor.fetchall()]
        
        for table in current_tables:
            if table.startswith('_') or table not in self.baseline['table_schemas']:
                continue
            
            try:
                cursor.execute(f"SHOW CREATE TABLE `{table}`")
                create_stmt = cursor.fetchone()
                current_hash = hashlib.md5(
                    str(create_stmt).encode()
                ).hexdigest()
                
                baseline_hash = self.baseline['table_schemas'][table]
                
                if current_hash != baseline_hash:
                    alert = {
                        'type': 'SCHEMA_CHANGED',
                        'severity': 'HIGH',
                        'table': table,
                        'timestamp': datetime.now().isoformat()
                    }
                    alerts.append(alert)
                    print(f"  ðŸš¨ {table}: ç»“æž„å·²å˜æ›´")
                else:
                    print(f"  âœ“ {table}: ç»“æž„æ­£å¸¸")
                
            except Exception as e:
                print(f"  âš ï¸  {table}: {e}")
        
        cursor.close()
        conn.close()
        
        return alerts
    
    def run_full_check(self):
        """è¿è¡Œå®Œæ•´æ£€æŸ¥"""
        print("="*70)
        print(f"ðŸ›¡ï¸  æ•°æ®ä¿æŠ¤æ£€æŸ¥ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("="*70)
        
        all_alerts = []
        
        all_alerts.extend(self.check_delete_anomaly())
        all_alerts.extend(self.check_schema_change())
        
        if all_alerts:
            with open(self.alert_file, 'w') as f:
                json.dump(all_alerts, f, indent=2)
            
            print(f"\nâŒ å‘çŽ° {len(all_alerts)} ä¸ªé—®é¢˜")
            
            pause_file = Path('/opt/mysql-sync/PAUSE_SYNC')
            with open(pause_file, 'w') as f:
                f.write(json.dumps({
                    'reason': 'Data protection alert',
                    'alerts': all_alerts,
                    'timestamp': datetime.now().isoformat()
                }, indent=2))
            
            print(f"ðŸš« å·²æš‚åœåŒæ­¥åˆ°Cloud SQL")
            
            # æž„å»ºå‘Šè­¦æ¶ˆæ¯
            alert_msg = f"æ£€æµ‹åˆ° {len(all_alerts)} ä¸ªæ•°æ®ä¿æŠ¤é—®é¢˜:\n\n"
            for i, alert in enumerate(all_alerts, 1):
                alert_type = alert.get('type', 'UNKNOWN')
                table = alert.get('table', 'N/A')
                alert_msg += f"{i}. {alert_type} - è¡¨: {table}\n"
            
            alert_msg += "\nåŒæ­¥å·²è‡ªåŠ¨æš‚åœï¼Œç­‰å¾…äººå·¥ç¡®è®¤ã€‚\n"
            alert_msg += "è¯¦æƒ…: cat /opt/mysql-sync/PAUSE_SYNC"
            
            # å‘é€é‚®ä»¶å‘Šè­¦
            send_alert(alert_msg, 'CRITICAL')
            
            return False
        else:
            print("\nâœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡")
            
            pause_file = Path('/opt/mysql-sync/PAUSE_SYNC')
            if pause_file.exists():
                pause_file.unlink()
                print("âœ“ åŒæ­¥å·²å¯ç”¨")
            
            self.save_baseline()
            return True

if __name__ == '__main__':
    protector = DataProtector()
    
    if len(sys.argv) > 1 and sys.argv[1] == 'init':
        protector.create_baseline()
    else:
        result = protector.run_full_check()
        sys.exit(0 if result else 1)
